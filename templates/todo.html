
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>待办事项管理器</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        .task-completed { text-decoration: line-through; color: #9ca3af; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .urgent { background-color: #fee2e2; border-left: 4px solid #ef4444; }
        .warning { background-color: #fef3c7; border-left: 4px solid #f59e0b; }
        .normal { background-color: #ecfdf5; border-left: 4px solid #10b981; }
        .import-export-btn { transition: all 0.2s ease; }
        .import-export-btn:hover { transform: translateY(-2px); }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-3xl">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-purple-600 p-6 text-white">
                <h1 class="text-2xl font-bold">待办事项管理器</h1>
                <p class="text-blue-100">记录您的工作与生活</p>
            </div>

            <div class="p-6">
                <div class="flex flex-wrap gap-3 mb-6">
                    <input type="text" id="taskInput" placeholder="添加新任务..." 
                           class="flex-1 px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <input type="datetime-local" id="dueDateInput" 
                           class="px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="addBtn" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition import-export-btn">
                        <i class="fas fa-plus mr-2"></i>添加
                    </button>
                    <div class="relative">
                        <button id="exportBtn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition import-export-btn">
                            <i class="fas fa-file-export mr-2"></i>导出
                        </button>
                        <div id="exportDropdown" class="hidden absolute right-0 mt-1 w-40 bg-white rounded-md shadow-lg z-10">
                            <a href="#" class="export-option block px-4 py-2 text-gray-800 hover:bg-gray-100" data-type="json">JSON格式</a>
                            <a href="#" class="export-option block px-4 py-2 text-gray-800 hover:bg-gray-100" data-type="csv">CSV格式</a>
                        </div>
                    </div>
                    <div class="relative">
                        <button id="importBtn" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg transition import-export-btn">
                            <i class="fas fa-file-import mr-2"></i>导入
                        </button>
                        <div id="importDropdown" class="hidden absolute right-0 mt-1 w-40 bg-white rounded-md shadow-lg z-10">
                            <label for="jsonImport" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 cursor-pointer">
                                <input type="file" id="jsonImport" class="hidden" accept=".json">JSON格式
                            </label>
                            <label for="csvImport" class="block px-4 py-2 text-gray-800 hover:bg-gray-100 cursor-pointer">
                                <input type="file" id="csvImport" class="hidden" accept=".csv">CSV格式
                            </label>
                        </div>
                    </div>
                </div>

                <div class="flex items-center mb-4">
                    <h2 class="text-xl font-semibold text-gray-700">我的待办事项</h2>
                    <div class="ml-auto flex items-center">
                        <span class="text-sm text-gray-500 mr-2">筛选:</span>
                        <select id="filterSelect" class="px-3 py-1 border rounded-lg focus:outline-none">
                            <option value="all">全部</option>
                            <option value="completed">已完成</option>
                            <option value="active">未完成</option>
                        </select>
                    </div>
                </div>

                <div id="taskList" class="space-y-3">
                    <!-- 任务列表将在这里动态生成 -->
                </div>

                <div id="emptyState" class="text-center py-8 text-gray-500">
                    <i class="fas fa-tasks text-4xl mb-2"></i>
                    <p>暂无待办事项</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化任务数组
        let todos = JSON.parse(localStorage.getItem('todos')) || [];
        
        // DOM元素
        const taskInput = document.getElementById('taskInput');
        const dueDateInput = document.getElementById('dueDateInput');
        const addBtn = document.getElementById('addBtn');
        const taskList = document.getElementById('taskList');
        const emptyState = document.getElementById('emptyState');
        const filterSelect = document.getElementById('filterSelect');
        const exportBtn = document.getElementById('exportBtn');
        const exportDropdown = document.getElementById('exportDropdown');
        const importBtn = document.getElementById('importBtn');
        const importDropdown = document.getElementById('importDropdown');
        const jsonImport = document.getElementById('jsonImport');
        const csvImport = document.getElementById('csvImport');
        
        // 初始化应用
        function init() {
            // 设置默认截止时间为明天此时
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const formattedDate = tomorrow.toISOString().slice(0, 16);
            dueDateInput.value = formattedDate;
            
            renderTasks();
            setupEventListeners();
        }
        
        // 设置事件监听器
        function setupEventListeners() {
            // 添加任务
            addBtn.addEventListener('click', addTask);
            taskInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') addTask();
            });
            
            // 筛选任务
            filterSelect.addEventListener('change', renderTasks);
            
            // 导出功能
            exportBtn.addEventListener('click', () => {
                exportDropdown.classList.toggle('hidden');
                importDropdown.classList.add('hidden');
            });
            
            // 导入功能
            importBtn.addEventListener('click', () => {
                importDropdown.classList.toggle('hidden');
                exportDropdown.classList.add('hidden');
            });
            
            // 导出选项点击
            document.querySelectorAll('.export-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();
                    exportTasks(e.target.dataset.type);
                    exportDropdown.classList.add('hidden');
                });
            });
            
            // 文件导入处理
            jsonImport.addEventListener('change', handleFileImport);
            csvImport.addEventListener('change', handleFileImport);
            
            // 点击其他地方关闭下拉菜单
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#exportBtn') && !e.target.closest('#exportDropdown')) {
                    exportDropdown.classList.add('hidden');
                }
                if (!e.target.closest('#importBtn') && !e.target.closest('#importDropdown')) {
                    importDropdown.classList.add('hidden');
                }
            });
        }
        
        // 添加新任务
        function addTask() {
            const taskText = taskInput.value.trim();
            if (taskText === '') {
                alert('请输入任务内容');
                return;
            }
            
            const dueDate = dueDateInput.value;
            if (!dueDate) {
                alert('请设置截止时间');
                return;
            }
            
            const newTask = {
                id: Date.now(),
                text: taskText,
                completed: false,
                createdAt: new Date().toISOString(),
                completedAt: null,
                dueDate: new Date(dueDate).getTime()
            };
            
            todos.unshift(newTask);
            saveAndRender();
            taskInput.value = '';
            taskInput.focus();
        }
        
        // 渲染任务列表
        function renderTasks() {
            const filter = filterSelect.value;
            const now = new Date().getTime();
            let filteredTasks = [...todos];
            
            if (filter === 'completed') {
                filteredTasks = todos.filter(task => task.completed);
            } else if (filter === 'active') {
                filteredTasks = todos.filter(task => !task.completed);
            }
            
            if (filteredTasks.length === 0) {
                taskList.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            taskList.innerHTML = '';
            
            filteredTasks.forEach(task => {
                const taskElement = document.createElement('div');
                taskElement.className = 'bg-white border rounded-lg p-4 flex items-center fade-in';
                taskElement.dataset.id = task.id;
                
                // 添加时间敏感样式
                if (!task.completed && task.dueDate) {
                    const timeLeft = task.dueDate - now;
                    const daysLeft = timeLeft / (1000 * 60 * 60 * 24);
                    
                    if (daysLeft <= 1) {
                        taskElement.classList.add('urgent');
                    } else if (daysLeft <= 2) {
                        taskElement.classList.add('warning');
                    } else if (daysLeft <= 7) {
                        taskElement.classList.add('normal');
                    }
                }
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'mr-3 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500';
                checkbox.checked = task.completed;
                checkbox.addEventListener('change', () => toggleTaskComplete(task.id));
                
                const taskContent = document.createElement('div');
                taskContent.className = 'flex-1';
                
                const taskText = document.createElement('div');
                taskText.className = (task.completed ? 'task-completed' : '') + ' font-medium';
                taskText.textContent = task.text;
                
                const taskDates = document.createElement('div');
                taskDates.className = 'text-sm text-gray-500 mt-1';
                
                // 创建时间
                const createdAtSpan = document.createElement('span');
                createdAtSpan.textContent = `创建: ${formatDate(task.createdAt)}`;
                
                // 完成时间
                if (task.completed && task.completedAt) {
                    const completedAtSpan = document.createElement('span');
                    completedAtSpan.className = 'ml-2';
                    completedAtSpan.textContent = `完成: ${formatDate(task.completedAt)}`;
                    taskDates.appendChild(completedAtSpan);
                }
                
                // 截止时间
                if (task.dueDate) {
                    const dueDateSpan = document.createElement('span');
                    dueDateSpan.className = 'ml-2';
                    const dueDate = new Date(task.dueDate);
                    const isOverdue = !task.completed && task.dueDate < now;
                    if (isOverdue) {
                        dueDateSpan.classList.add('text-red-500', 'font-medium');
                    }
                    dueDateSpan.textContent = `截止: ${formatDate(dueDate.toISOString())}`;
                    taskDates.appendChild(dueDateSpan);
                }
                
                taskDates.prepend(createdAtSpan);
                taskContent.appendChild(taskText);
                taskContent.appendChild(taskDates);
                
                // 操作按钮
                const actionButtons = document.createElement('div');
                actionButtons.className = 'flex items-center ml-2';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'text-red-500 hover:text-red-700';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    deleteTask(task.id);
                });
                
                actionButtons.appendChild(deleteBtn);
                
                taskElement.appendChild(checkbox);
                taskElement.appendChild(taskContent);
                taskElement.appendChild(actionButtons);
                
                taskList.appendChild(taskElement);
            });
        }
        
        // 切换任务完成状态
        function toggleTaskComplete(id) {
            const taskIndex = todos.findIndex(task => task.id === id);
            if (taskIndex === -1) return;
            
            todos[taskIndex].completed = !todos[taskIndex].completed;
            todos[taskIndex].completedAt = todos[taskIndex].completed ? new Date().toISOString() : null;
            
            saveAndRender();
        }
        
        // 删除任务
        function deleteTask(id) {
            if (confirm('确定要删除这个任务吗？')) {
                todos = todos.filter(task => task.id !== id);
                saveAndRender();
            }
        }
        
        // 保存到本地存储并重新渲染
        function saveAndRender() {
            localStorage.setItem('todos', JSON.stringify(todos));
            renderTasks();
        }
        
        // 格式化日期
        function formatDate(isoString) {
            if (!isoString) return '';
            const date = new Date(isoString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }
        
        // 导出任务
        function exportTasks(format) {
            if (todos.length === 0) {
                alert('没有可导出的任务');
                return;
            }
            
            let data, mimeType, extension;
            
            if (format === 'json') {
                data = JSON.stringify({ todos }, null, 2);
                mimeType = 'application/json';
                extension = 'json';
            } else if (format === 'csv') {
                let csv = '任务内容,状态,创建时间,完成时间,截止时间\n';
                todos.forEach(task => {
                    csv += `"${task.text.replace(/"/g, '""')}",${task.completed ? '已完成' : '未完成'},"${formatDate(task.createdAt)}","${task.completed ? formatDate(task.completedAt) : ''}","${task.dueDate ? formatDate(new Date(task.dueDate).toISOString()) : ''}"\n`;
                });
                data = csv;
                mimeType = 'text/csv';
                extension = 'csv';
            }
            
            const blob = new Blob([data], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `待办事项_${new Date().toISOString().slice(0,10)}.${extension}`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 处理文件导入
        function handleFileImport(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileType = e.target.fileName ? e.target.fileName.split('.').pop() : 
                                      file.name.split('.').pop().toLowerCase();
                    let importedTodos = [];
                    
                    if (fileType === 'json') {
                        const result = JSON.parse(e.target.result);
                        if (!result.todos && !Array.isArray(result)) {
                            throw new Error('JSON文件格式不正确');
                        }
                        importedTodos = result.todos || result;
                    } else if (fileType === 'csv') {
                        const csv = e.target.result;
                        const lines = csv.split('\n').slice(1);
                        importedTodos = lines.filter(line => line.trim()).map(line => {
                            const values = line.split(',');
                            return {
                                id: Date.now() + Math.floor(Math.random() * 1000),
                                text: values[0].replace(/^"|"$/g, ''),
                                completed: values[1] === '已完成',
                                createdAt: values[2] ? new Date(values[2].replace(/^"|"$/g, '')).toISOString() : new Date().toISOString(),
                                completedAt: values[3] ? new Date(values[3].replace(/^"|"$/g, '')).toISOString() : null,
                                dueDate: values[4] ? new Date(values[4].replace(/^"|"$/g, '')).getTime() : null
                            };
                        });
                    } else {
                        throw new Error('不支持的文件格式');
                    }
                    
                    // 验证导入数据
                    if (!Array.isArray(importedTodos)) {
                        throw new Error('导入数据格式不正确');
                    }
                    
                    // 合并数据（可选择替换或追加）
                    if (confirm(`导入 ${importedTodos.length} 条任务。是否替换现有任务？(取消将追加到现有任务)`)) {
                        todos = importedTodos;
                    } else {
                        todos = [...importedTodos, ...todos];
                    }
                    
                    saveAndRender();
                    alert(`成功导入 ${importedTodos.length} 条待办事项`);
                } catch (error) {
                    alert('导入失败: ' + error.message);
                    console.error(error);
                }
            };
            
            reader.readAsText(file);
            e.target.value = ''; // 重置文件输入
        }
        
        // 初始化应用
        init();
    </script>
</body>
</html>
