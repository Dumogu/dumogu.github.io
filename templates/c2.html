<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多文件表格拼接工具 - 纯前端实现</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            padding: 25px 30px;
            text-align: center;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            font-weight: 600;
        }
        
        .subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
            gap: 20px;
        }
        
        .upload-section {
            flex: 1;
            min-width: 350px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .preview-section {
            flex: 2;
            min-width: 700px;
            display: flex;
            flex-direction: column;
        }
        
        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
            max-height: 400px;
            overflow-y: auto;
            padding: 10px;
        }
        
        .preview-table {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }
        
        .preview-header {
            background: #4b6cb7;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-container {
            max-height: 250px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }
        
        th, td {
            border: 1px solid #e1e1e1;
            padding: 8px 10px;
            text-align: left;
        }
        
        th {
            background-color: #f1f5f9;
            font-weight: 600;
            position: sticky;
            top: 0;
        }
        
        tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #444;
        }
        
        input[type="file"], input[type="number"] {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 1rem;
            transition: all 0.3s;
        }
        
        input[type="file"]:focus, input[type="number"]:focus {
            outline: none;
            border-color: #4b6cb7;
            box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
        }
        
        .file-info {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #666;
        }
        
        .btn {
            background: linear-gradient(90deg, #4b6cb7 0%, #182848 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #a0a0a0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-small {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn-add {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            margin-bottom: 15px;
        }
        
        .btn-remove {
            background: linear-gradient(90deg, #dc3545 0%, #c82333 100%);
            margin-left: 10px;
        }
        
        .file-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .file-input {
            flex: 1;
        }
        
        .result-section {
            margin-top: 25px;
            padding: 20px;
            background: #f0f7ff;
            border-radius: 8px;
            border-left: 4px solid #4b6cb7;
        }
        
        .result-section h3 {
            margin-bottom: 15px;
            color: #182848;
        }
        
        .message {
            padding: 12px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }
        
        .btn-download {
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
        }
        
        .instructions {
            background: #f0f7ff;
            padding: 20px;
            border-radius: 8px;
            margin-top: 25px;
        }
        
        .instructions h3 {
            margin-bottom: 15px;
            color: #182848;
        }
        
        .instructions ol {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .file-list {
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #e1e1e1;
            border-radius: 6px;
            padding: 10px;
            background: white;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-item-info {
            display: flex;
            flex-direction: column;
        }
        
        .file-item-name {
            font-weight: 600;
        }
        
        .file-item-size {
            font-size: 0.8rem;
            color: #666;
        }
        
        .file-item-actions {
            display: flex;
            gap: 5px;
        }
        
        .file-item-move {
            background: #6c757d;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .file-item-remove {
            background: #dc3545;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 3px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .upload-section, .preview-section {
                min-width: 100%;
            }
            
            .preview-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>多文件表格拼接工具</h1>
            <p class="subtitle">支持一次性选择多个文件 · 纯前端实现 · 无需上传服务器</p>
        </header>
        
        <div class="main-content">
            <div class="upload-section">
                <h3>表格文件上传</h3>
                
                <div class="form-group">
                    <label for="startRow">拼接起始行 (从第几行开始拼接)</label>
                    <input type="number" id="startRow" min="1" value="1">
                </div>
                
                <div class="form-group">
                    <label for="multiFileInput">选择多个表格文件 (CSV或Excel)</label>
                    <input type="file" id="multiFileInput" accept=".csv,.xlsx,.xls" multiple>
                    <div class="file-info">可按住Ctrl或Shift键选择多个文件</div>
                </div>
                
                <div class="file-list" id="fileList">
                    <div class="empty-state">
                        <p>尚未选择任何文件</p>
                    </div>
                </div>
                
                <div class="form-group" style="margin-top: 20px;">
                    <button id="processBtn" class="btn">处理所有表格</button>
                </div>
                
                <div class="message" id="message"></div>
            </div>
            
            <div class="preview-section">
                <h3>表格预览</h3>
                
                <div class="preview-container" id="previewContainer">
                    <div class="empty-state">
                        <p>上传表格文件后，预览将显示在这里</p>
                    </div>
                </div>
                
                <div class="preview-table">
                    <div class="preview-header">
                        <span>合并结果预览</span>
                        <span id="rowCountResult">0行</span>
                    </div>
                    <div class="table-container">
                        <table id="previewResult">
                            <thead>
                                <tr><th>处理后将显示合并结果</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="result-section" id="resultSection" style="display: none;">
            <h3>表格处理完成</h3>
            <p>所有表格已成功拼接，您可以选择以下操作：</p>
            <div class="action-buttons">
                <button id="downloadCsv" class="btn btn-download">下载为CSV文件</button>
                <button id="downloadExcel" class="btn btn-download">下载为Excel文件</button>
            </div>
        </div>
        
        <div class="instructions">
            <h3>使用说明</h3>
            <ol>
                <li>点击"选择文件"按钮，可以一次性选择多个表格文件（支持CSV和Excel格式）</li>
                <li>设置拼接起始行（从第几行开始拼接，表头行不计入）</li>
                <li>可以在文件列表中调整文件顺序或删除不需要的文件</li>
                <li>点击"处理所有表格"按钮，预览合并结果</li>
                <li>确认无误后，下载合并后的文件（CSV或Excel格式）</li>
                <li>所有处理均在浏览器中完成，不会上传到任何服务器</li>
            </ol>
        </div>
    </div>

    <script>
        // 全局变量存储表格数据
        let tableData = []; // 存储所有表格的数据
        let mergedData = null;
        let tableHeaders = [];
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 多文件选择事件
            document.getElementById('multiFileInput').addEventListener('change', handleMultiFileSelect);
            
            // 处理按钮点击事件
            document.getElementById('processBtn').addEventListener('click', processAllTables);
            
            // 下载按钮事件
            document.getElementById('downloadCsv').addEventListener('click', function() {
                downloadMergedTable('csv');
            });
            
            document.getElementById('downloadExcel').addEventListener('click', function() {
                downloadMergedTable('excel');
            });
        });
        
        // 处理多文件选择
        function handleMultiFileSelect(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            // 清空现有数据
            tableData = [];
            
            // 更新文件列表显示
            updateFileList(files);
            
            // 解析所有文件
            files.forEach((file, index) => {
                parseFile(file, index);
            });
        }
        
        // 更新文件列表显示
        function updateFileList(files) {
            const fileListElement = document.getElementById('fileList');
            
            // 清空现有内容
            fileListElement.innerHTML = '';
            
            if (files.length === 0) {
                fileListElement.innerHTML = '<div class="empty-state"><p>尚未选择任何文件</p></div>';
                return;
            }
            
            // 添加文件项
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-item-info">
                        <span class="file-item-name">${file.name}</span>
                        <span class="file-item-size">${formatFileSize(file.size)}</span>
                    </div>
                    <div class="file-item-actions">
                        <button class="file-item-move" onclick="moveFileUp(${index})" ${index === 0 ? 'disabled' : ''}>↑</button>
                        <button class="file-item-move" onclick="moveFileDown(${index})" ${index === files.length - 1 ? 'disabled' : ''}>↓</button>
                        <button class="file-item-remove" onclick="removeFile(${index})">×</button>
                    </div>
                `;
                fileListElement.appendChild(fileItem);
            });
        }
        
        // 上移文件
        function moveFileUp(index) {
            if (index <= 0) return;
            
            // 交换文件顺序
            const fileInput = document.getElementById('multiFileInput');
            const files = Array.from(fileInput.files);
            
            // 交换文件
            [files[index], files[index - 1]] = [files[index - 1], files[index]];
            
            // 更新文件输入
            updateFileInput(files);
            
            // 交换表格数据
            if (tableData[index] && tableData[index - 1]) {
                [tableData[index], tableData[index - 1]] = [tableData[index - 1], tableData[index]];
            }
            
            // 重新解析和预览
            reparseAndPreviewAll();
        }
        
        // 下移文件
        function moveFileDown(index) {
            const fileInput = document.getElementById('multiFileInput');
            const files = Array.from(fileInput.files);
            
            if (index >= files.length - 1) return;
            
            // 交换文件顺序
            [files[index], files[index + 1]] = [files[index + 1], files[index]];
            
            // 更新文件输入
            updateFileInput(files);
            
            // 交换表格数据
            if (tableData[index] && tableData[index + 1]) {
                [tableData[index], tableData[index + 1]] = [tableData[index + 1], tableData[index]];
            }
            
            // 重新解析和预览
            reparseAndPreviewAll();
        }
        
        // 移除文件
        function removeFile(index) {
            const fileInput = document.getElementById('multiFileInput');
            const files = Array.from(fileInput.files);
            
            // 移除文件
            files.splice(index, 1);
            
            // 更新文件输入
            updateFileInput(files);
            
            // 移除表格数据
            tableData.splice(index, 1);
            
            // 重新解析和预览
            reparseAndPreviewAll();
        }
        
        // 更新文件输入
        function updateFileInput(files) {
            const fileInput = document.getElementById('multiFileInput');
            
            // 创建新的FileList（由于安全限制，不能直接修改files属性）
            const dataTransfer = new DataTransfer();
            files.forEach(file => dataTransfer.items.add(file));
            
            fileInput.files = dataTransfer.files;
            
            // 更新文件列表显示
            updateFileList(files);
        }
        
        // 重新解析和预览所有文件
        function reparseAndPreviewAll() {
            const fileInput = document.getElementById('multiFileInput');
            const files = Array.from(fileInput.files);
            
            // 清空预览
            const previewContainer = document.getElementById('previewContainer');
            previewContainer.innerHTML = '<div class="empty-state"><p>上传表格文件后，预览将显示在这里</p></div>';
            
            // 清空结果区域
            document.getElementById('resultSection').style.display = 'none';
            
            if (files.length === 0) {
                tableData = [];
                return;
            }
            
            // 重新解析所有文件
            tableData = [];
            files.forEach((file, index) => {
                parseFile(file, index);
            });
        }
        
        // 解析上传的文件
        function parseFile(file, index) {
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // 获取第一个工作表
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // 转换为JSON
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // 存储表格数据
                    tableData[index] = {
                        data: jsonData,
                        fileName: file.name.replace(/\.[^/.]+$/, "") // 移除扩展名
                    };
                    
                    // 如果是第一个表格，保存表头
                    if (index === 0 && jsonData.length > 0) {
                        tableHeaders = jsonData[0];
                    }
                    
                    // 更新预览
                    updatePreview(index, jsonData);
                    
                    showMessage(`表格${index+1}解析成功`, 'success');
                } catch (error) {
                    console.error('解析错误:', error);
                    showMessage(`表格${index+1}解析失败: ${error.message}`, 'error');
                }
            };
            
            reader.onerror = function() {
                showMessage('文件读取失败', 'error');
            };
            
            // 读取文件
            if (file.name.endsWith('.csv')) {
                // 对于CSV文件，使用readAsText
                const textReader = new FileReader();
                textReader.onload = function(e) {
                    try {
                        const csvData = e.target.result;
                        const lines = csvData.split('\n').map(line => {
                            // 简单的CSV解析（注意：不处理带逗号的引用字段）
                            return line.split(',').map(cell => cell.trim());
                        });
                        
                        // 存储表格数据
                        tableData[index] = {
                            data: lines,
                            fileName: file.name.replace(/\.[^/.]+$/, "")
                        };
                        
                        // 如果是第一个表格，保存表头
                        if (index === 0 && lines.length > 0) {
                            tableHeaders = lines[0];
                        }
                        
                        // 更新预览
                        updatePreview(index, lines);
                        
                        showMessage(`表格${index+1}解析成功`, 'success');
                    } catch (error) {
                        console.error('CSV解析错误:', error);
                        showMessage(`表格${index+1}解析失败: ${error.message}`, 'error');
                    }
                };
                textReader.readAsText(file);
            } else {
                // 对于Excel文件，使用readAsArrayBuffer
                reader.readAsArrayBuffer(file);
            }
        }
        
        // 更新单个表格的预览
        function updatePreview(index, data) {
            const previewContainer = document.getElementById('previewContainer');
            
            // 如果预览容器是空状态，先清除空状态
            const emptyState = previewContainer.querySelector('.empty-state');
            if (emptyState) {
                previewContainer.removeChild(emptyState);
            }
            
            // 查找或创建预览卡片
            let previewCard = document.getElementById(`previewTable${index}`);
            if (!previewCard) {
                previewCard = document.createElement('div');
                previewCard.className = 'preview-table';
                previewCard.id = `previewTable${index}`;
                previewContainer.appendChild(previewCard);
            }
            
            if (!data || data.length === 0) {
                previewCard.innerHTML = `
                    <div class="preview-header">
                        <span>表格 ${index+1}</span>
                        <span>0行</span>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr><th>无数据</th></tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                `;
                return;
            }
            
            // 更新行数显示
            const rowCount = data.length;
            
            // 构建表格HTML
            let tableHTML = '<table>';
            
            // 添加表头
            tableHTML += '<thead><tr>';
            if (data.length > 0) {
                data[0].forEach(cell => {
                    tableHTML += `<th>${cell || '[空]'}</th>`;
                });
            }
            tableHTML += '</tr></thead>';
            
            // 添加数据行（最多显示5行）
            tableHTML += '<tbody>';
            const maxRows = Math.min(data.length, 6); // 表头+5行数据
            
            for (let i = 1; i < maxRows; i++) {
                tableHTML += '<tr>';
                data[i].forEach(cell => {
                    tableHTML += `<td>${cell || ''}</td>`;
                });
                tableHTML += '</tr>';
            }
            
            // 如果数据行数超过预览限制，添加提示行
            if (data.length > maxRows) {
                tableHTML += `<tr><td colspan="${data[0].length}" style="text-align: center; font-style: italic;">... 还有 ${data.length - maxRows} 行数据未显示</td></tr>`;
            }
            
            tableHTML += '</tbody></table>';
            
            previewCard.innerHTML = `
                <div class="preview-header">
                    <span>表格 ${index+1}</span>
                    <span>${rowCount}行</span>
                </div>
                <div class="table-container">
                    ${tableHTML}
                </div>
            `;
        }
        
        // 处理所有表格拼接
        function processAllTables() {
            const startRow = parseInt(document.getElementById('startRow').value) - 1; // 转换为0基索引
            
            // 检查是否有表格数据
            const validTables = tableData.filter(table => table !== null && table.data);
            if (validTables.length === 0) {
                showMessage('请先上传至少一个表格文件', 'error');
                return;
            }
            
            if (isNaN(startRow) || startRow < 0) {
                showMessage('请输入有效的起始行数', 'error');
                return;
            }
            
            // 检查起始行是否超出表格范围
            for (let i = 0; i < validTables.length; i++) {
                if (startRow >= validTables[i].data.length) {
                    showMessage(`起始行超出表格${i+1}的范围`, 'error');
                    return;
                }
            }
            
            try {
                // 执行表格拼接
                mergedData = [];
                
                // 添加表头（使用第一个表格的表头）
                if (validTables[0].data.length > 0) {
                    mergedData.push(validTables[0].data[0]);
                }
                
                // 从指定行开始添加所有表格的数据
                validTables.forEach(table => {
                    for (let i = startRow + 1; i < table.data.length; i++) {
                        mergedData.push(table.data[i]);
                    }
                });
                
                // 更新结果预览
                updateResultPreview(mergedData);
                document.getElementById('rowCountResult').textContent = `${mergedData.length}行`;
                
                // 显示结果区域
                document.getElementById('resultSection').style.display = 'block';
                
                showMessage(`表格拼接成功！共合并 ${validTables.length} 个表格，${mergedData.length - 1} 行数据`, 'success');
            } catch (error) {
                console.error('处理错误:', error);
                showMessage('表格处理失败: ' + error.message, 'error');
            }
        }
        
        // 更新结果预览
        function updateResultPreview(data) {
            const previewTable = document.getElementById('previewResult');
            
            if (!data || data.length === 0) {
                previewTable.innerHTML = '<tr><td>无数据</td></tr>';
                return;
            }
            
            // 清空表格
            previewTable.innerHTML = '';
            
            // 添加表头
            let thead = document.createElement('thead');
            let headerRow = document.createElement('tr');
            
            if (data.length > 0) {
                data[0].forEach(cell => {
                    let th = document.createElement('th');
                    th.textContent = cell || '[空]';
                    headerRow.appendChild(th);
                });
            }
            
            thead.appendChild(headerRow);
            previewTable.appendChild(thead);
            
            // 添加数据行（最多显示10行）
            let tbody = document.createElement('tbody');
            const maxRows = Math.min(data.length, 11); // 表头+10行数据
            
            for (let i = 1; i < maxRows; i++) {
                let row = document.createElement('tr');
                data[i].forEach(cell => {
                    let td = document.createElement('td');
                    td.textContent = cell || '';
                    row.appendChild(td);
                });
                tbody.appendChild(row);
            }
            
            // 如果数据行数超过预览限制，添加提示行
            if (data.length > maxRows) {
                let row = document.createElement('tr');
                let td = document.createElement('td');
                td.colSpan = data[0].length;
                td.textContent = `... 还有 ${data.length - maxRows} 行数据未显示`;
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                row.appendChild(td);
                tbody.appendChild(row);
            }
            
            previewTable.appendChild(tbody);
        }
        
        // 下载合并后的表格
        function downloadMergedTable(format) {
            if (!mergedData || mergedData.length === 0) {
                showMessage('没有可下载的数据', 'error');
                return;
            }
            
            try {
                let blob, fileName, mimeType;
                const dateStr = new Date().toISOString().split('T')[0];
                
                if (format === 'csv') {
                    // 生成CSV内容
                    const csvContent = mergedData.map(row => 
                        row.map(cell => `"${cell}"`).join(',')
                    ).join('\n');
                    
                    blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    fileName = `merged_tables_${dateStr}.csv`;
                    mimeType = 'text/csv';
                } else {
                    // 生成Excel文件
                    const worksheet = XLSX.utils.aoa_to_sheet(mergedData);
                    const workbook = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(workbook, worksheet, '合并数据');
                    
                    const excelBuffer = XLSX.write(workbook, { bookType: 'xlsx', type: 'array' });
                    blob = new Blob([excelBuffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                    fileName = `merged_tables_${dateStr}.xlsx`;
                    mimeType = 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet';
                }
                
                // 创建下载链接
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }, 100);
                
                showMessage(`文件已开始下载: ${fileName}`, 'success');
            } catch (error) {
                console.error('下载错误:', error);
                showMessage('文件下载失败: ' + error.message, 'error');
            }
        }
        
        // 显示消息
        function showMessage(text, type) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            
            // 5秒后自动隐藏消息
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000);
        }
        
        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
