<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Excel工作表合并工具（保留边框样式）</title>
    <script src="../static/script/xlsx.full.min.js"></script>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #f5f7fa;
        color: #333;
      }
      h1 {
        color: #2c3e50;
        text-align: center;
        margin-bottom: 30px;
      }
      .upload-container {
        background-color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-bottom: 30px;
        text-align: center;
      }
      .file-input {
        margin: 15px 0;
        padding: 10px;
        border: 2px dashed #3498db;
        border-radius: 5px;
        background-color: #f8fafc;
        width: 100%;
        box-sizing: border-box;
      }
      .button {
        background-color: #3498db;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
        margin: 5px;
      }
      .button:hover {
        background-color: #2980b9;
      }
      .button:disabled {
        background-color: #95a5a6;
        cursor: not-allowed;
      }
      .button-success {
        background-color: #2ecc71;
      }
      .button-success:hover {
        background-color: #27ae60;
      }
      .results-container {
        display: none;
        background-color: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        margin-top: 20px;
      }
      .summary {
        margin-bottom: 20px;
        padding: 15px;
        border-radius: 5px;
        background-color: #f8f9fa;
      }
      .passed {
        border-left: 5px solid #2ecc71;
      }
      .failed {
        border-left: 5px solid #e74c3c;
      }
      .results-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      .results-table th,
      .results-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
      }
      .results-table th {
        background-color: #f1f5f9;
        font-weight: 600;
      }
      .error-row {
        background-color: #ffebee;
      }
      .success-row {
        background-color: #e8f5e9;
      }
      .icon {
        margin-right: 8px;
      }
      .success-icon {
        color: #2ecc71;
      }
      .error-icon {
        color: #e74c3c;
      }
      .progress-container {
        margin: 15px 0;
        height: 20px;
        background-color: #ecf0f1;
        border-radius: 10px;
        overflow: hidden;
      }
      .progress-bar {
        height: 100%;
        background-color: #3498db;
        width: 0%;
        transition: width 0.3s;
      }
      .status-text {
        margin: 10px 0;
        font-style: italic;
        color: #7f8c8d;
      }
    </style>
  </head>
  <body>
    <h1>中豫港务预算合并工具</h1>

    <div class="upload-container">
      <h2>上传Excel文件</h2>
      <input type="file" id="fileInput" class="file-input" accept=".xlsx" multiple />
      <div class="progress-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <div class="status-text" id="statusText">选择文件后点击处理</div>
      <button class="button" onclick="processFiles()" id="processBtn">处理文件</button>
      <button class="button button-success" onclick="exportResult()" id="exportBtn" disabled>导出合并结果</button>
    </div>

    <div id="resultsContainer" class="results-container">
      <h2>处理结果</h2>
      <div id="summary" class="summary"></div>

      <table class="results-table">
        <thead>
          <tr>
            <th>工作表</th>
            <th>状态</th>
            <th>文件数</th>
            <th>单元格数</th>
            <th>详情</th>
          </tr>
        </thead>
        <tbody id="resultsBody">
          <!-- 处理结果将在这里动态生成 -->
        </tbody>
      </table>
    </div>

    <script>
      // 存储所有工作簿数据
      let allWorkbooks = [];
      // 存储合并结果
      let mergedWorkbook = null;

      // 处理上传的文件
      function processFiles() {
        const fileInput = document.getElementById("fileInput");
        const resultsContainer = document.getElementById("resultsContainer");
        const resultsBody = document.getElementById("resultsBody");
        const summaryDiv = document.getElementById("summary");
        const processBtn = document.getElementById("processBtn");
        const progressBar = document.getElementById("progressBar");
        const statusText = document.getElementById("statusText");

        if (!fileInput.files.length) {
          alert("请先选择一个或多个Excel文件");
          return;
        }

        // 重置状态
        resultsBody.innerHTML = "";
        summaryDiv.innerHTML = "";
        allWorkbooks = [];
        mergedWorkbook = null;
        document.getElementById("exportBtn").disabled = true;
        processBtn.disabled = true;
        progressBar.style.width = "0%";
        statusText.textContent = "开始处理文件...";

        const files = Array.from(fileInput.files);
        const totalFiles = files.length;
        let processedFiles = 0;

        // 处理每个文件
        files.forEach((file, index) => {
          console.log(`正在处理文件: ${file.name}, 索引: ${index}`);
          const reader = new FileReader();

          reader.onload = function (e) {
            try {
              const data = new Uint8Array(e.target.result);
              const workbook = XLSX.read(data, { type: "array", cellStyles: true });

              // 存储工作簿和文件名
              allWorkbooks.push({
                name: file.name,
                workbook: workbook,
              });

              processedFiles++;
              const progress = Math.round((processedFiles / totalFiles) * 100);
              progressBar.style.width = `${progress}%`;
              statusText.textContent = `处理中: ${processedFiles}/${totalFiles} (${progress}%)`;

              // 所有文件处理完成
              if (processedFiles === totalFiles) {
                statusText.textContent = "所有文件处理完成，正在合并工作表...";

                // 合并工作表
                mergeWorkbooks();

                // 显示结果容器
                resultsContainer.style.display = "block";
                processBtn.disabled = false;
                document.getElementById("exportBtn").disabled = false;
              }
            } catch (error) {
              console.error("处理Excel文件时出错:", error);
              statusText.textContent = `处理文件 ${file.name} 时出错: ${error.message}`;
              processedFiles++;
            }
          };

          reader.onerror = function () {
            console.error(`读取文件 ${file.name} 时出错`);
            statusText.textContent = `读取文件 ${file.name} 时出错`;
            processedFiles++;
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // 合并工作簿（保留边框样式）
      function mergeWorkbooks() {
        const summaryDiv = document.getElementById("summary");
        const resultsBody = document.getElementById("resultsBody");

        // 创建新的工作簿用于存储合并结果
        mergedWorkbook = XLSX.utils.book_new();

        // 收集所有工作表名
        const allSheetNames = new Set();
        allWorkbooks.forEach((wb) => {
          wb.workbook.SheetNames.forEach((name) => allSheetNames.add(name));
        });

        // 处理每个工作表
        const sheetResults = [];
        let totalCells = 0;
        let successCount = 0;

        allSheetNames.forEach((sheetName) => {
          // 查找所有包含此工作表的工作簿
          const workbooksWithSheet = allWorkbooks.filter((wb) => wb.workbook.SheetNames.includes(sheetName));
          console.log(sheetName.toString());
          let minROW = 4;
          let minCOL = 1;
          let maxROW = 0;
          let maxCOL = 0;
          switch (sheetName.toString()) {
            case "期间费用预算":
              maxROW = 121;
              maxCOL = 10;
              break;
            case "利润表预算":
              maxROW = 51;
              maxCOL = 17;
              break;
            case "现金流量预算":
              maxROW = 43;
              maxCOL = 10;
              break;
            case "资产负债表预算":
              maxROW = 49;
              maxCOL = 13;
              break;
            case "固定资产购置预算":
              maxROW = 15;
              maxCOL = 8;
              break;
            default:
              maxROW = 0;
              maxCOL = 0;
          }
          console.log(minROW, minCOL, maxROW, maxCOL);
          if (workbooksWithSheet.length === 0) return;

          // 获取第一个工作表的样式作为基础
          const firstSheet = workbooksWithSheet[0].workbook.Sheets[sheetName];
          const mergedSheet = JSON.parse(JSON.stringify(firstSheet)); // 深拷贝
          //   console.log(mergedSheet);

          // 获取工作表范围
          const range = XLSX.utils.decode_range(mergedSheet["!ref"]);
          console.log("(", range.s.r, ",", range.s.c, ")->(", range.e.r, ",", range.e.c, ")");
          let cellCount = 0;
          let successCells = 0;

          // 合并数据
          for (let R = minROW; R <= maxROW; ++R) {
            for (let C = minCOL; C <= maxCOL; ++C) {
              const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
              const baseCell = mergedSheet[cellAddress];
              if (baseCell) {
                baseCell.s = baseCell.s || {};
                console.log("basecell111:", baseCell);
              } // 确保样式对象存在，以防某些单元格没有样式属性

              console.log("basecell:", baseCell);
              // 跳过标题行（假设第一行是标题）
              if (R === range.s.r) {
                cellCount++;
                successCells++;
                continue;
              }

              // 合并其他工作簿的数据
              let mergedValue = baseCell ? baseCell.v : null;

              for (let i = 1; i < workbooksWithSheet.length; i++) {
                const wb = workbooksWithSheet[i];
                const sheet = wb.workbook.Sheets[sheetName];
                const otherCell = sheet[cellAddress];

                if (otherCell) {
                  // 数字相加，字符串保留
                  if (typeof mergedValue === "number" && typeof otherCell.v === "number") {
                    mergedValue += otherCell.v;
                  } else if (baseCell && baseCell.t === "s") {
                    // 保留原始字符串
                  } else if (otherCell.t === "s") {
                    mergedValue = otherCell.v;
                  }
                  console.log("base", baseCell.s.cellStyles, otherCell.s);
                }
              }

              // 更新单元格值
              if (baseCell) {
                baseCell.v = mergedValue;
              }

              cellCount++;
              successCells++;
            }
          }

          // 更新工作表引用
          mergedSheet["!ref"] = XLSX.utils.encode_range(range);

          // 添加到结果工作簿
          XLSX.utils.book_append_sheet(mergedWorkbook, mergedSheet, sheetName);

          // 记录结果
          const status =
            workbooksWithSheet.length > 1
              ? `<span class="icon success-icon">✓</span> 已合并`
              : `<span class="icon error-icon">⚠</span> 已转移`;

          sheetResults.push({
            sheet: sheetName,
            status: status,
            files: workbooksWithSheet.length,
            cells: cellCount,
            details: `${successCells}/${cellCount} 单元格成功`,
          });

          totalCells += cellCount;
          successCount++;
        });

        // 更新摘要信息
        summaryDiv.className = "summary passed";
        summaryDiv.innerHTML = `
                <span class="icon success-icon">✓</span>
                <strong>合并完成！</strong> 
                共处理 ${allWorkbooks.length} 个文件，${successCount} 个工作表已合并。
                总计 ${totalCells} 个单元格。
            `;

        // 添加结果到表格
        sheetResults.forEach((result) => {
          const row = document.createElement("tr");
          row.innerHTML = `
                    <td>${result.sheet}</td>
                    <td>${result.status}</td>
                    <td>${result.files}</td>
                    <td>${result.cells}</td>
                    <td>${result.details}</td>
                `;
          resultsBody.appendChild(row);
        });
      }

      // 导出合并结果
      function exportResult() {
        console.log(mergedWorkbook);

        // 生成Excel文件
        XLSX.writeFile(mergedWorkbook, "合并结果-另存.xlsx");
      }
    </script>
  </body>
</html>
